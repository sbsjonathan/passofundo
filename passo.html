<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle - Pedágios & Combustível</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --line:rgba(255,255,255,.12);
      --shadow:0 18px 55px rgba(0,0,0,.35);
      --r:18px;
      --pad:14px;
      --accent:#7c4dff;
      --good:#1dd1a1;
      --danger:#ff5d5d;
      --focus:rgba(124,77,255,.45);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      color:var(--text);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 600px at 15% 10%, rgba(124,77,255,.35), transparent 55%),
        radial-gradient(900px 520px at 85% 20%, rgba(29,209,161,.22), transparent 60%),
        radial-gradient(900px 520px at 50% 110%, rgba(255,93,93,.14), transparent 55%),
        linear-gradient(180deg, #070b13 0%, #0b1220 50%, #070b13 100%);
      min-height:100vh;
      padding:16px 14px 34px;
    }

    .wrap{ max-width:520px; margin:0 auto; }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin:6px 2px 12px;
    }

    h1{
      font-size:20px;
      margin:0;
      letter-spacing:.2px;
    }

    .card{
      background:linear-gradient(180deg, var(--card) 0%, rgba(255,255,255,.045) 100%);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px var(--pad);
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:12px;
      user-select:none;
    }

    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(124,77,255,.18);
    }
    .dot.good{ background:var(--good); box-shadow:0 0 0 4px rgba(29,209,161,.16); }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    button{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      font-weight:600;
      letter-spacing:.2px;
      cursor:pointer;
      transition:transform .06s ease, background .2s ease, border-color .2s ease;
      -webkit-tap-highlight-color:transparent;
    }
    button:active{ transform:scale(.98); }
    button.primary{
      border-color:rgba(124,77,255,.55);
      background:rgba(124,77,255,.18);
    }
    button.danger{
      border-color:rgba(255,93,93,.55);
      background:rgba(255,93,93,.14);
    }

    .scroller{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    table{
      width:100%;
      border-collapse:collapse;
      /* Aumentei min-width para caber a coluna Hora sem espremer */
      min-width: 600px; 
    }

    thead th{
      text-align:left;
      font-size:11px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.35px;
      padding:10px var(--pad);
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
      white-space:nowrap;
      position:sticky;
      top:0;
      z-index:2;
    }

    tbody td{
      padding:8px var(--pad);
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
      background:transparent;
    }
    tbody tr:hover td{ background:rgba(255,255,255,.02); }

    .cell-id{
      width:35px;
      color:var(--muted);
      font-weight:800;
      font-size: 12px;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }

    .input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-size:13px;
      min-height:36px;
      font-family: inherit;
    }
    .input:focus{
      border-color:rgba(124,77,255,.7);
      box-shadow:0 0 0 4px var(--focus);
    }
    
    /* Estilo especifico para input de hora */
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      opacity: 0.6;
    }

    .col-local{ min-width: 150px; } 
    .col-tipo{ min-width: 80px; }
    .col-valor{ min-width: 90px; }
    .col-litros{ min-width: 90px; }
    .col-hora{ min-width: 95px; } /* Nova coluna */

    .typeWrap{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .seg{
      display:inline-flex;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:10px;
      overflow:hidden;
      min-height:36px;
    }
    .seg button{
      border:none;
      background:transparent;
      padding:6px 10px;
      font-weight:800;
      font-size:12px;
      min-width:38px;
      border-radius:0;
    }
    .seg button.on{
      background:rgba(124,77,255,.22);
      box-shadow: inset 0 0 0 1px rgba(124,77,255,.45);
    }

    .litrosSlot{
      transition: opacity .15s ease, transform .15s ease;
    }
    .litrosSlot.hidden{
      opacity:0;
      transform: translateY(-3px);
      pointer-events:none;
    }

    .cell-actions{
      width:40px;
      text-align:right;
      white-space:nowrap;
    }
    .icon-btn{
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      width:36px;
      height:36px;
      font-size:12px;
    }
    .icon-btn.del{
      border-color:rgba(255,93,93,.45);
      background:rgba(255,93,93,.12);
    }

    .totals{
      padding: 12px var(--pad);
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .totalRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:13px;
      font-weight:800;
    }
    /* Alvo para os labels */
    .totalLabel{ color:var(--muted); font-weight:700; }
    .totalRow .num{ font-variant-numeric: tabular-nums; }

    @media (max-width: 520px){
      .wrap{ max-width: 520px; }
      table{ min-width: 600px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Controle</h1>
    </header>

    <div class="card">
      <div class="toolbar">
        <div class="chips">
          <span class="chip"><span class="dot"></span>Itens</span>
          <span class="chip"><span class="dot good"></span>Totais</span>
        </div>
        <div class="actions">
          <button class="primary" id="btnAdd">+ Adicionar</button>
          <button class="danger" id="btnReset">Reset</button>
        </div>
      </div>

      <div class="scroller">
        <table aria-label="Tabela de gastos">
          <thead>
            <tr>
              <th>#</th>
              <th>Local</th>
              <th>P/C</th>
              <th>Valor</th>
              <th>Litros</th>
              <th>Hora</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="totals">
        <div class="totalRow">
          <span class="totalLabel">Total combustível</span>
          <span class="num" id="totalComb">R$ 0,00</span>
        </div>
        <div class="totalRow">
          <!-- Labels com IDs para atualizar o texto (X abastecimentos) -->
          <span class="totalLabel" id="lblLitros">Total litros</span>
          <span class="num" id="totalLitros">0,00 L</span>
        </div>
        <div class="totalRow">
          <span class="totalLabel" id="lblPed">Total pedágio</span>
          <span class="num" id="totalPed">R$ 0,00</span>
        </div>
        <div class="totalRow" style="padding-top:6px;border-top:1px solid rgba(255,255,255,.10);">
          <span class="totalLabel">Total geral</span>
          <span class="num" id="totalGeral">R$ 0,00</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Atualizado com itens 13-16 e campo Hora vazio por padrão
    const DEFAULT_ROWS = [
      { local: "Seropedica",          tipo: "P", valor: "16,40", litros: "", hora: "" },
      { local: "Itatiaia",            tipo: "P", valor: "14,50", litros: "", hora: "" },
      { local: "Guaratinguetá",       tipo: "C", valor: "170,31", litros: "37,93", hora: "" },
      { local: "Pindamonhangaba",     tipo: "P", valor: "16,90", litros: "", hora: "" },
      { local: "Jacarei",             tipo: "P", valor: "8,10",  litros: "", hora: "" },
      { local: "Guararema",           tipo: "P", valor: "4,50",  litros: "", hora: "" },
      { local: "Arujá",               tipo: "P", valor: "4,50",  litros: "", hora: "" },
      { local: "São Paulo",           tipo: "P", valor: "4,60",  litros: "", hora: "" },
      { local: "Osasco",              tipo: "P", valor: "3,50",  litros: "", hora: "" },
      { local: "São Lourenço Serra",  tipo: "P", valor: "4,30",  litros: "", hora: "" },
      { local: "Juquitiba",           tipo: "C", valor: "150,06", litros: "33,42", hora: "" },
      { local: "Miracatu",            tipo: "P", valor: "4,30",   litros: "", hora: "" },
      { local: "Juquia",              tipo: "P", valor: "4,30",   litros: "", hora: "" },
      { local: "Cajati",              tipo: "P", valor: "4,30",   litros: "", hora: "" },
      { local: "Barra do Turvo - SP", tipo: "P", valor: "4,30",   litros: "", hora: "" },
      { local: "Antonina - PR",       tipo: "C", valor: "182,40", litros: "36,12", hora: "" }
    ];

    const STORAGE_KEY = "controle_gastos_v6"; // v6

    const tbody = document.getElementById("tbody");
    
    // Elementos de Valor
    const totalComb = document.getElementById("totalComb");
    const totalPed = document.getElementById("totalPed");
    const totalGeral = document.getElementById("totalGeral");
    const totalLitros = document.getElementById("totalLitros");
    
    // Labels para atualizar texto de contagem
    const lblLitros = document.getElementById("lblLitros");
    const lblPed = document.getElementById("lblPed");

    const btnAdd = document.getElementById("btnAdd");
    const btnReset = document.getElementById("btnReset");

    function deepCopy(obj){
      return JSON.parse(JSON.stringify(obj));
    }

    function loadRows(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return deepCopy(DEFAULT_ROWS);
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return deepCopy(DEFAULT_ROWS);
        return parsed.map(r => ({
          local: (r?.local ?? "").toString(),
          tipo: ((r?.tipo ?? "P").toString().toUpperCase() === "C") ? "C" : "P",
          valor: (r?.valor ?? "").toString(),
          litros: (r?.litros ?? "").toString(),
          hora: (r?.hora ?? "").toString()
        }));
      }catch{
        return deepCopy(DEFAULT_ROWS);
      }
    }

    function saveRows(rows){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
    }

    function normalizeMoneyInput(s){
      s = (s ?? "").toString();
      s = s.replace(/[^\d,\.]/g, "");
      const parts = s.split(/[,.]/);
      if(parts.length === 1) return parts[0];
      const dec = parts.pop();
      const int = parts.join("");
      return int + "," + dec;
    }

    function parseMoneyBR(s){
      if(typeof s !== "string") return 0;
      const t = s.trim();
      if(!t) return 0;
      const lastComma = t.lastIndexOf(",");
      const lastDot = t.lastIndexOf(".");
      let normalized = t;
      if(lastComma > -1 && lastDot > -1){
        const decIsComma = lastComma > lastDot;
        normalized = decIsComma
          ? t.replace(/\./g, "").replace(",", ".")
          : t.replace(/,/g, "");
      }else{
        normalized = t.replace(",", ".");
      }
      const n = Number(normalized);
      return Number.isFinite(n) ? n : 0;
    }

    function formatBRL(n){
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function formatLitros(n){
      return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " L";
    }

    function isZeroLikeMoney(s){
      const n = parseMoneyBR(s);
      return !s || s.trim()==="" || n === 0;
    }

    function makeCellInput({ value, placeholder, inputMode="text", type="text" }){
      const inp = document.createElement("input");
      inp.className = "input";
      inp.value = value ?? "";
      if(type !== "time") {
        inp.placeholder = placeholder ?? "";
      }
      inp.inputMode = inputMode;
      inp.type = type;
      return inp;
    }

    function setTipo(idx, tipo){
      rows[idx].tipo = (tipo === "C") ? "C" : "P";
      if(rows[idx].tipo !== "C"){
        rows[idx].litros = "";
      }
      saveRows(rows);
      render();
      updateTotals();
    }

    function render(){
      tbody.innerHTML = "";

      rows.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.className = "cell-id";
        tdId.textContent = String(idx + 1);

        // Local
        const tdLocal = document.createElement("td");
        tdLocal.className = "col-local";
        const inLocal = makeCellInput({ value: row.local, placeholder: "Local" });
        inLocal.addEventListener("input", () => {
          rows[idx].local = inLocal.value;
          saveRows(rows);
        });
        tdLocal.appendChild(inLocal);

        // Tipo
        const tdTipo = document.createElement("td");
        tdTipo.className = "col-tipo";
        const seg = document.createElement("div");
        seg.className = "seg";
        const bP = document.createElement("button");
        bP.type = "button";
        bP.textContent = "P";
        bP.className = (row.tipo === "P") ? "on" : "";
        bP.addEventListener("click", () => setTipo(idx, "P"));
        const bC = document.createElement("button");
        bC.type = "button";
        bC.textContent = "C";
        bC.className = (row.tipo === "C") ? "on" : "";
        bC.addEventListener("click", () => setTipo(idx, "C"));
        seg.appendChild(bP);
        seg.appendChild(bC);
        tdTipo.appendChild(seg);

        // Valor
        const tdValor = document.createElement("td");
        tdValor.className = "col-valor";
        const inValor = makeCellInput({
          value: row.valor,
          placeholder: "0,00",
          inputMode: "decimal"
        });
        if(isZeroLikeMoney(row.valor) && row.valor === "") inValor.value = "";
        inValor.addEventListener("input", () => {
          const norm = normalizeMoneyInput(inValor.value);
          rows[idx].valor = norm;
          saveRows(rows);
          updateTotals();
        });
        tdValor.appendChild(inValor);

        // Litros
        const tdLitros = document.createElement("td");
        tdLitros.className = "col-litros";
        const litrosSlot = document.createElement("div");
        litrosSlot.className = "litrosSlot" + (row.tipo === "C" ? "" : " hidden");
        const inLitros = makeCellInput({
          value: row.litros,
          placeholder: "Lts",
          inputMode: "decimal"
        });
        inLitros.addEventListener("input", () => {
          rows[idx].litros = normalizeMoneyInput(inLitros.value);
          saveRows(rows);
          updateTotals();
        });
        litrosSlot.appendChild(inLitros);
        tdLitros.appendChild(litrosSlot);

        // Hora (NOVO)
        const tdHora = document.createElement("td");
        tdHora.className = "col-hora";
        const inHora = makeCellInput({
          value: row.hora,
          type: "time"
        });
        inHora.addEventListener("input", () => {
          rows[idx].hora = inHora.value;
          saveRows(rows);
        });
        tdHora.appendChild(inHora);

        // Ações
        const tdActions = document.createElement("td");
        tdActions.className = "cell-actions";
        const btnDel = document.createElement("button");
        btnDel.className = "icon-btn del";
        btnDel.type = "button";
        btnDel.textContent = "✕";
        btnDel.addEventListener("click", () => {
          rows.splice(idx, 1);
          saveRows(rows);
          render();
          updateTotals();
        });
        tdActions.appendChild(btnDel);

        tr.appendChild(tdId);
        tr.appendChild(tdLocal);
        tr.appendChild(tdTipo);
        tr.appendChild(tdValor);
        tr.appendChild(tdLitros);
        tr.appendChild(tdHora);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      updateTotals();
    }

    function updateTotals(){
      let totalC = 0;
      let totalP = 0;
      let totalL = 0;
      
      let countC = 0; // Contador Combustível
      let countP = 0; // Contador Pedágio

      for(const r of rows){
        const v = parseMoneyBR(r.valor);
        const l = parseMoneyBR(r.litros);

        if(r.tipo === "C") {
          totalC += v;
          totalL += l;
          countC++;
        } else {
          totalP += v;
          countP++;
        }
      }

      const geral = totalC + totalP;

      totalComb.textContent = formatBRL(totalC);
      
      // Atualiza label e valor dos Litros
      lblLitros.textContent = `Total litros (${countC} abast.)`;
      totalLitros.textContent = formatLitros(totalL);

      // Atualiza label e valor dos Pedágios
      lblPed.textContent = `Total pedágio (${countP} paradas)`;
      totalPed.textContent = formatBRL(totalP);

      totalGeral.textContent = formatBRL(geral);
    }

    btnAdd.addEventListener("click", () => {
      rows.push({ local:"", tipo:"P", valor:"", litros:"", hora:"" });
      saveRows(rows);
      render();
      setTimeout(() => {
        const last = tbody.querySelector("tr:last-child td.col-local input");
        if(last) last.focus();
      }, 0);
    });

    btnReset.addEventListener("click", () => {
      if(confirm("Deseja resetar para os valores padrão?")){
        rows = deepCopy(DEFAULT_ROWS);
        saveRows(rows);
        render();
      }
    });

    let rows = loadRows();
    render();
  </script>
</body>
</html>